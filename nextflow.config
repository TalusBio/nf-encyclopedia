// Profiles
profiles {
    standard {
        process {
            executor = 'local'
            withName: 'ENCYCLOPEDIA_.*' {
                container = 'docker-encyclopedia'
            }
            withName: 'MSCONVERT' {
                container = 'docker-msconvert'
            }
            withName: 'MSSTATS' {
                container = 'docker-msstats'
            }
        }
    }
    cloud {
        process {
            executor = 'awsbatch'
            errorStrategy = 'retry'
            maxRetries = 3
            withName: 'ENCYCLOPEDIA_LOCAL' {
                container = '622568582929.dkr.ecr.us-west-2.amazonaws.com/docker-encyclopedia'
                queue = 'terraform-nextflow-medium-size-spot-batch-job-queue'
                memory = 31100.MB
                cpus = 4
            }
            withName: 'ENCYCLOPEDIA_GLOBAL' {
                container = '622568582929.dkr.ecr.us-west-2.amazonaws.com/docker-encyclopedia'
                queue = 'terraform-nextflow-large-size-spot-batch-job-queue'
                memory = 62000.MB
                cpus = 4
            }
            withName: 'MSCONVERT' {
                container = '622568582929.dkr.ecr.us-west-2.amazonaws.com/docker-msconvert'
                queue = 'terraform-nextflow-medium-size-spot-batch-job-queue'
                memory = 7700.MB
                cpus = 2
            }
            withName: 'MSSTATS' {
                container = '622568582929.dkr.ecr.us-west-2.amazonaws.com/docker-msstats'
                queue = 'terraform-nextflow-medium-size-spot-batch-job-queue'
                memory = 15400.MB
                cpus = 2
            }
        }
    }
}

// Docker Parameters
docker {
    enabled = true
}

// Pipeline Parameters
params {
    experimentName = 'purple-pig'
    publish_dir = 'results'
    store_dir = 'store'
    mzml_dir = 'mzml'
    ms_file_csv = ''
    use_msstats = true
    aggregate = false
    email = ''

    encyclopedia {
        fasta = ''
        dlib = ''
        memory = '-Xmx24G'
        chrlib_postfix = 'chr'
        quant_postfix = 'quant'
        global_postfix = 'global'
        percolator_version = 'v3-05'
        percolator_train_fdr = '0.00'
        percolator_training_set_size = '5000000'
        local_options = '-frag HCD -scoringBreadthType recal'
        global_options = ''
    }

    msconvert {
        verbose = '-v'
        gzip = '--gzip'
        options = '--mzML --64 --zlib'
        filters = '--filter "peakPicking true 1-" --filter "demultiplex optimization=overlap_only"'
    }
}

// Plugins
plugins {
    id 'nf-amazon'
}

// AWS Setup
aws {
    region = 'us-west-2'
    client {
        storageEncryption = 'AES256'
    }
    batch {
        cliPath = '/home/ec2-user/bin/aws'
        jobRole = 'arn:aws:iam::622568582929:role/terraform-nextflow-batch-job-role'
    }
}
